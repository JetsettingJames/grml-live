#!/bin/sh
# Filename:      grml-setlang
# Purpose:       set language system-wide on grml system
# Authors:       grml-team (grml.org), (c) Michael Prokop <mika@grml.org>
# Bug-Reports:   see http://grml.org/bugs/
# License:       This file is licensed under the GPL v2.
################################################################################

PN="$(basename "$0")"
DIALOG=dialog
LANGFUNC=/etc/grml/language-functions

# notice: Debian's locales.postinst has been modified to write
# locale variables into /etc/default/locale instead of
# /etc/environment; the latter file is a PAM configuration file,
# so modifying it was a policy violation.
CONFFILE=/etc/default/locale

# shellcheck disable=SC1091
{
. /etc/grml/script-functions
. /etc/grml/lsb-functions
}

check4root || exit 100

eindent # as we are running inside grml boot sequence as well make sure we integrate fine

# allow writing $CONFFILE non-interactive via "grml-setlang $LANGUAGE"
if [ -n "$1" ] ; then
   NONINTERACTIVE=1
else
   NONINTERACTIVE=''
fi

if ! [ -r "$LANGFUNC" ] ; then
   echo "$LANGFUNC could not be read. Make sure you have package grml-autoconfig installed." >&2
   exit 1
fi

setvalue(){
  [ -n "$2" ] || return 1
  # already present in conffile?
  if grep -q "^${1}" "$CONFFILE" ; then
     sed -i --follow-symlinks "s#^${1}.*#${1}${2}#"  $CONFFILE
  # is the new Debian style /etc/default/locale present?
  elif grep -q "^# ${1}$" "$CONFFILE" ; then
     # shellcheck disable=SC1117
     sed -i --follow-symlinks "s#^\# ${1}#${1}${2}#" $CONFFILE
  else
     echo "$1${2}" >> $CONFFILE
  fi
}

# Generate locale if necessary
generate_locale(){
  local locale="$1"

  # If locales-all is installed, we don't need to generate anything
  if dpkg -s locales-all >/dev/null 2>&1 ; then
    return 0
  fi

  # Check if locale is already in /etc/locale.gen
  if ! grep -q "^$locale " /etc/locale.gen 2>/dev/null ; then
    # Add the locale to /etc/locale.gen
    echo "$locale UTF-8" >> /etc/locale.gen

    # Remove autogenerated markers if present
    sed -i --follow-symlinks '/^# This file was created by grml-live/d' /etc/locale.gen
    sed -i --follow-symlinks '/^# XXX GENERATED XXX/d' /etc/locale.gen

    # Generate the locale
    locale-gen --keep-existing >/dev/null 2>&1
  fi
}

# grml-small does not provide any further locales
if grep -q small /etc/grml_version 2>/dev/null ; then
   if [ -z "$NONINTERACTIVE" ] ; then
      LANG=C $DIALOG --stdout --msgbox "Notice: grml-small does not provide a full language setup.

You have to make sure the appropriate packages are installed." 0 0
      exit 1
   else
      esyslog user.notice "$PN" 'grml-small does not provide a full language setup.'
   fi
fi

# shellcheck disable=SC1091
{
[ -r /etc/environment ]    && . /etc/environment
[ -r /etc/default/locale ] && . /etc/default/locale
}
[ -n "$LANGUAGE" ] && DEFAULT_LANGUAGE="$LANGUAGE"

if [ -z "$DEFAULT_LANGUAGE" ] ; then
   DEFAULT_LANGUAGE=en
fi

if [ -z "$NONINTERACTIVE" ] ; then
# shellcheck disable=SC1010
{
   LANGUAGE=$(LANG=C $DIALOG --stdout --title "$PN" --default-item $DEFAULT_LANGUAGE --radiolist \
"Which language do you want to use?

This will affect \$LANG, \$LANGUAGE and \$LC_MESSAGES.

Notice: if you want to adjust /etc/locale.gen (defines
which locales should be generated by locale-gen)
please run 'dpkg-reconfigure locales' manually.

Configuration will be written to $CONFFILE" 0 0 0 \
 at 'austrian' off \
 au 'austrialian' off \
 be 'belgian' off \
 bg 'bulgarian' off \
 br 'brazilian' off \
 ch 'swiss-german' off \
 cf 'french canadian' off \
 cn 'chinese' off \
 cs 'czech' off \
 cz 'czech' off \
 de 'german' off \
 dk 'dansk' off \
 da 'dansk' off \
 el 'greek' off \
 en 'english [us] (grml default)' on \
 es 'spanish' off \
 fi 'finnish' off \
 fr 'french' off \
 ga 'irish gaeilge' off \
 he 'hebrew' off \
 hu 'hungarian' off \
 il 'hebrew' off \
 ie 'irish' off \
 it 'italian' off \
 ja 'japanese' off \
 nl 'dutch' off \
 pl 'polish' off \
 pt 'portuguese' off \
 ru 'russian' off \
 sk 'slovak' off \
 sl 'slovenian' off \
 tr 'turkish' off \
 tw 'chinese (traditional)' off \
 uk 'british' off \
 us 'american' off \
)
}

  retval=$?
  case $retval in
      (0)   # everything ok
            ;;
      (1)   echo "Cancel pressed." ; exit 1 ;;
      (255) echo "ESC pressed."    ; exit 1 ;;
  esac

else # non-interactive
  LANGUAGE="$1"
fi

if ! grep -qe "${LANGUAGE})" -qe "${LANGUAGE}|" $LANGFUNC ; then
   ewarn "Language ${LANGUAGE} not supported, using default." ; eend 0
fi

# fallback to C if using an ISO system (which is latin1 for LC_CTYPE);
# this should prevent users from broken ctype settings if the set
# locale isn't available on a remote system
if echo "$LANGUAGE" | grep -q -- '-iso' ; then
   LC_CTYPE=C
fi

# read in the file where all the $LANGUAGE stuff is defined
# shellcheck disable=SC1090
. $LANGFUNC

# make sure the file exists
if ! [ -r $CONFFILE ] ; then
cat > $CONFFILE <<EOF
# File generated by $PN on $(date)
LANG=$LANG
# LC_CTYPE=$LC_CTYPE
# LANGUAGE=$LANGUAGE
# TZ=$TZ
# other environment variables you might want to set:
# LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY
# LC_MESSAGES LC_PAPER LC_NAME LC_ADDRESS
# LC_TELEPHONE LC_MEASUREMENT LC_IDENTIFICATION
#
# Note: set LC_ALL to overwrite all LC_* variables
#       LC_ALL > LC_* > LANG
#       LANGUAGE is glibc only and binds stronger than LC_ALL
EOF
fi

# Remove grml-live header when the file gets changed
if [ -r "$CONFFILE" ] && grep -q "# grml-live" "$CONFFILE" ; then
  sed -i --follow-symlinks '/^# grml-live/d' "$CONFFILE"
fi

# Generate locale if necessary
generate_locale "$LANG"

setvalue 'LANG='     "$LANG"

retval=$?
case $retval in
    (0)
          if [ -z "$NONINTERACTIVE" ] ; then
             LANG=C $DIALOG --stdout --msgbox "Writing language settings ($LANGUAGE) to $CONFFILE was successful." 0 0
          else
             einfo "Writing language settings ($LANGUAGE) to $CONFFILE was successful."
             esyslog user.notice "$PN" "Writing language settings ($LANGUAGE) to $CONFFILE was successful." ; eend 0
          fi
          ;;
    *)
          if [ -z "$NONINTERACTIVE" ] ; then
             LANG=C $DIALOG --stdout --msgbox "Error writing settings for $LANGUAGE to $CONFFILE." 0 0
          else
             eerror "Error writing settings for $LANGUAGE to $CONFFILE." ; eend 1
             esyslog user.notice "$PN" "Error writing settings for $LANGUAGE to $CONFFILE."
          fi
          ;;
esac

eoutdent

## END OF FILE #################################################################
