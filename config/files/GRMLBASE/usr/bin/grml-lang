#!/bin/bash
# Filename:      grml-lang
# Purpose:       load specific keyboard layout settings
# Authors:       grml-team (grml.org), (c) Michael Prokop <mika@grml.org>
# Bug-Reports:   see http://grml.org/bugs/
# License:       This file is licensed under the GPL v2.
################################################################################

CONFFILE=/etc/default/keyboard
PN="$(basename "$0")"

usage(){
    echo "Usage: ${PN} <language>"
    echo "supported values: at, ch, de, dvorak, es, fr, hu, it, jp, uk, us"
}

setvalue(){
  sudo sed -i --follow-symlinks "s#^${1}=.*#${1}=\"${2}\"#" "${CONFFILE}"
}

# Update keyboard configuration and apply changes
configure_keyboard(){
  local layout="$1"
  local variant="${2:-}"

  # Update /etc/default/keyboard
  if [ -r "$CONFFILE" ] ; then
    setvalue XKBLAYOUT "$layout"
    setvalue XKBVARIANT "$variant"
  else
    # Create the file if it doesn't exist
    sudo tee "$CONFFILE" > /dev/null <<EOF
# Keyboard configuration for grml
XKBMODEL="pc105"
XKBLAYOUT="$layout"
EOF
    if [ -n "$variant" ] ; then
      echo "XKBVARIANT=\"$variant\"" | sudo tee -a "$CONFFILE" > /dev/null
    fi
  fi

  # Apply keyboard changes immediately:
  # Let setupcon update the files /etc/console-setup/cached*. It will also try
  # to activate the new configuration.
  sudo setupcon --force --save
  # However, due to an apparenty loadkeys or kernel limitation, when the current
  # screen is managed by X11, loadkeys *without* -u fails or does nothing. Force
  # loading the keymap for the linux virtual consoles.
  sudo loadkeys -u /etc/console-setup/cached_UTF-8_del.kmap.gz
  # Trigger udev rules for input devices. If X11 is installed, this will make
  # udev pick up /etc/default/keyboard, and X11 will pick up the keymap from udev.
  sudo udevadm trigger --subsystem-match=input --action=change
}

if [ $# -lt "1" ] ; then
   usage >&2
   exit 1
fi

LANGUAGE="$1"

# shellcheck disable=SC1091
. /usr/share/grml-autoconfig/language-functions

# Check if we found a valid keyboard configuration
if [ -z "$XKEYBOARD" ] ; then
  echo "E: No valid language given."
  echo
  usage
  echo
  echo "Notice: grml-lang now configures keyboard layout via /etc/default/keyboard."
  echo "For locale settings, use grml-setlang."
  exit 1
fi

if [ -n "$XKEYBOARD" ] ; then
  # Determine variant based on language
  case "$LANGUAGE" in
    de|at)
      configure_keyboard "$XKEYBOARD" "nodeadkeys"
      ;;
    *)
      configure_keyboard "$XKEYBOARD"
      ;;
  esac
fi

echo "Keyboard layout configured: $XKEYBOARD"
[ -n "$2" ] && echo "Variant: $2"
echo "Done."

## END OF FILE #################################################################
